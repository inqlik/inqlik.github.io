<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
		
      <title>inqlik.gitgub.io</title>
		
    <link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="all" />
    <link rel="alternate" title="inqlik.gitgub.io" type="application/atom+xml" href="/atom.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
		<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css' /> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="Viewport" content="maximum-scale=1.8,width=720" />
    <link rel="stylesheet" href="/stylesheets/qlikview.css">
    <script src="/stylesheets/highlight.pack.js"></script>
    <script>
     hljs.configure({tabReplace: '    '});
      hljs.initHighlightingOnLoad();
    </script>
    <link href='http://inqlik.github.io/feed.xml' rel='alternate' type='application/atom+xml'>
  </head>
 
  <body>
	
    <div id="header">
    	<h1>
    		<a href="/" title="inqlik.gitgub.io">Inqlik blog</a>
    	</h1>
    </div>
    <div id="navigation">
    	<ul>
    		<li><a href="/" title="Blog">Blog</a>&bull;</li> 
    		<li><a href="/archive/" title="Archive of this Blog">Archive</a>&bull;</li>
        <li><a href="/osp/" title="Open Source projects">Open Source</a>&bull;</li> 
    		<li><a href="/about/" title="About this Blog">About</a></li>
    	</ul>
    </div>			

    <div class="clear_both"></div>

		

  <h2><a href="/2014/02/expression-editor/" title="[Permalink] InQlik Expression Editor in QlikView Deployment Framework environment">InQlik Expression Editor in QlikView Deployment Framework environment</a></h2>
	<div class="post_date">22 February 2014</div>
 
  <p>We’ve switched to QlikView Deployment Framework recently so adjusting our current toolset to new environment was a great opportunity to rethink some approaches and implement some properties in alternative way. In this post I’d like to present some background design considerations and current state of one of these tools - Expression Editor. </p>

<p>Expression Editor is a module in <a href="https://github.com/inqlik/inqlik-tools">InQlik Tools</a> - free open-source package for Sublime Text editor. Overview of Sublime Text itself you may find <a href="http://www.linuxjournal.com/content/sublime-text-one-editor-rule-them-all">here</a></p>

<p>Basically at the moment InQlik Tools consist of</p>

<ul>
  <li>Language syntax plugin for qvs script files</li>
  <li>Integrated QVD metadata viewer</li>
  <li>Expression Editor</li>
</ul>

<p>Other parts of InQlik Tools may be subject of another post. Lets look at Expression Editor.</p>

<p>We started to use external storage for variables of our QlikView applications almost from start of our involvement with QlikView. I sincerely believe that any form of external maintenance is superior to direct editing of chart diagram expressions. So we started with external Excel files with variable expressions. It has feelings of <em>right thing to do in the long run</em> but sort of a impediment in the direct design process. And obviously while Excel files excel in some other aspects - as a target format for version control systems they are not very helpful.</p>

<p>So we sought and tried other tools: better editors for tabular data and so on. Wishes for the future instrument were:</p>

<ul>
  <li>Ideally it should have a text format for best interoperability with VCS</li>
  <li>Readability: Variables and expressions are first of all program code. They contain huge part of overall logic of end-user application. By old rule of the thumb any line of program code is read ten times more frequently then written or changed. </li>
  <li>Decent experience while writing code: Ideally you should have same sort of help as in Expression Editor within QlikView application</li>
  <li>Metadata support. Any variable has a name. But variables in end-user QlikView application are mostly not simple variables. Frequenlty they represent an instance of a chart expression. Each of such an expression necessarily has to have at least <code>Label</code> and <code>Comment</code> for its visual representation in a chart. Some have <code>Background Color</code> and so on. It would be nice to have all these related properties stored together.</li>
  <li>Should load to QlikView effectively</li>
</ul>

<p>Some our previous attempts were:</p>

<ul>
  <li>Tabular text format with support from ST plugin. Fail on readability and comfort of editing with large expressions.</li>
  <li>YAML format with QlikView <code>Load from YAML</code> function. That was a more less promising direction, but a writing decent text parser in QlikView script is not such an attractive task.</li>
</ul>

<p>Our current solution to this:</p>

<ul>
  <li>YAML like format. 
    <ul>
      <li>Good for reading. </li>
      <li>Compatibility with YAML is broken to allow less ceremony while writing the code. For example: In YAML there is special symbol for beginning of multiline string. Expression editor knows that expression definition can be multiline, so there is no need to designate multiline string explicitly</li>
      <li>Very good with regard to CVS </li>
    </ul>
  </li>
  <li>On the fly generation of csv file in format of variable csv file of QlikView Deployment Framework</li>
  <li>Syntax highlighting for proprietary tags and for QlikView expressions in definitions parts</li>
</ul>

<p>To get some view of this instrument, lets look how we can use Expression Editor to modify sample app from QlikView Deployment Framework. (All app used are available at download link below)</p>

<p>Original sample application do not use external storage of variables. All expression defined (sometimes repeatedly) inside charts.</p>

<p>So our <strong>first step</strong> would be extracting expressions from original application:
<img src="/images/north-1.png" alt="Original sample" /></p>

<p>Next: write down expressions in Expression Editor. I transfer Name, Definition, Label and Comment for each chart expression used in sample application. <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> </p>

<p><img src="/images/expression-editor-1.png" alt="Expression Editor 1" /></p>

<p><strong>Next step</strong>: Lets replace hard written values with values from external repository</p>

<p><img src="/images/north-2.png" alt="Sample with expressions" /></p>

<p>On that step you can see some characteristics of that technique. 
- Inline expression for average order now replaced by $(AvgOrder). It seems to be an unquestionable improvement.<br />
- Plain text label <code>Avg order value</code> replaced by formula <code>=AvgOrder.Label</code>. Admittedly it looks not so pretty as original text. And given full row of such labels at <strong>Expressions</strong>, <strong>Number</strong> or <strong>Axes</strong> tabs or Properties dialog their repeated <code>.Label</code> parts somewhat irritate eyes.</p>

<ul>
  <li>=Sales.Label</li>
  <li>=AvgOrder.Label</li>
  <li>=Sales1998.Label</li>
  <li>=Sales1997.Label</li>
</ul>

<p>But I would argue that it is an improvement anyway: I believe that in such overview panels with many expressions in row - most important feature is a unambiguity. Looking at row above I immediately and confidently may expect that second expression in that chart correspond to expression AvgOrder in external storage. On the other hand <code>Avg order value</code> label and all the more <code>1998</code> label in big application can correspond to several terminal expressions. <sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p>

<p>Just for sake of demonstration purpose I add <code>Sales.BackgroundColor</code> to <code>Sales</code> expression so on the whole it looks like</p>

<pre><code>
---
SET: Sales
Definition: Sum(Quantity*UnitPrice)
Label: Sales
Comment: Sales amount for selected period
BackgroundColor: =LightGreen(96)

</code></pre>

<p>Next I use this variable for Sales chart expression both on Dashboard and Sales sheets of application. Now we’ve got nice uniformly greenish color for Sales across two charts.</p>

<p><img src="/images/north-3.png" alt="Sample with expressions 2" /></p>

<p>On the next step I’ll implement somewhat contrived task for that demo: localization of UI. 
Do not blame me, it is definitely not the working solution and most part of applications will stay in English no matter what. I’ll just try to demonstrate some points.</p>

<p>Lets save our CustomVariables file as CustomVariables_i18n and modify it:</p>

<pre><code>
---
SET: AvgOrder
Definition: Sum(Quantity*UnitPrice)/Count(DISTINCT OrderID)
Label: Avg order value
Comment: Avg order value
</code></pre>
<p>changed to</p>

<pre><code>
---
SET: AvgOrder
Definition: Sum(Quantity*UnitPrice)/Count(DISTINCT OrderID)
Label: =If($(russianNotSelected),'Avg order value','Средний чек')
Comment: =If($(russianNotSelected),'Avg order value','Средний чек')
</code></pre>

<p><img src="/images/expression-editor-2.png" alt="Expression Editor 2" /></p>

<p>Next: Lets change our LoadApp script so it would load new version of expressions and additionally load isolate table with languages: En and Ru</p>

<p>Now reload sample application and it will respond on language selection - labels and help string of our charts will be localized. And what is most nice - we do not change anything in the end-user application for that. </p>

<p><img src="/images/north-4.png" alt="Sample with expressions 4" /></p>

<p>In common programming parlance: Presentation layer was separated from domain model layer and that did provide opportunity to make changes in that layers somewhat independently. <sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup> Labels and Comments work nicely when they are just string values, and continue to work without any changes when they become dynamic expressions themselves. </p>

<p>Admittedly it was rather contrived example. In our projects only tiny amount of labels and comments are dynamic. Actually much more used and valuable is ability to manage all comments and labels as a string in one place.</p>

<p>Thus we have completed our demo project and seen basic usage of expression editor. Lets see some additional features</p>

<h4 id="additional-structure-and-fast-navigation">Additional structure and fast navigation</h4>

<p>Names of expression in expression file marked as symbols. Additionally there is way group any logically related group of expressions in section within expression file. It provide opportunity to get some structure of expression file. See result go Goto Symbol (<code>Ctrl-R</code>) command.</p>

<p><img src="/images/expression-editor-3.png" alt="Goto symbol" /></p>

<p>On this tiny sample it is not important, but in real projects that is quite useful. Note, that I set colon sign before section name. It is not required but with such convention I could easily filter that symbols list just to sections, and thus move fast between sections</p>

<p><img src="/images/expression-editor-4.png" alt="Goto symbol 2" /></p>

<p>Another feature useful in real size project: Goto definition (<code>F12</code>) command. With it you could place cursor into any variable in expression (for example into <code>$(russianNotSelected)</code>) and immediately jump to line where that variable is defined in same file or other file of same project. Then you return to original spot by <code>Alt -</code> key combination.</p>

<h4 id="configurable-settings">Configurable settings</h4>

<p>By default Expression editor use ExpressionName.TagName naming convention. You can change it Package Settings. Your variables could look like Sales_Label if you set <code>separator</code> field to value ‘_’.
I prefer dot as separator because QlikView works very nice with it. You double click on name part of expression and QlikView select only that part. Double click on Tag part of expression and QlikView select only Tag part. So you for example can copy fully populated chart expression, paste it and then easily change name parts of expression in all fields.
Additionally you can change tag to expression mappings. Actually we use a Russian names for our expression, so our expression for <code>Sales</code> would be <code>Продажи</code>. With ‘label’ tag mapped to <code>Заголовок</code> in User settings our corresponding variable is named <code>Продажи.Заголовок</code>
Another setting is <code>output_mode</code>. By default Expression editor produce CSV file in QDF variable format on every save. If you set parameter <code>output_mode</code> to QVS instead of QDF Expression editor would generate plain QVS script with LET and SET commands.</p>

<p><img src="/images/expression-editor-5.png" alt="QVS output_format" /></p>

<p>Consider this mode as experimental - we tentatively choose CSV output format as a default for our projects so it is currently more tested</p>

<h3 id="macros">Macros</h3>

<p>There is well known bug/feature in QlikView dollar sign macro expansion: you can not pass parameter containing comma in it. There is known workaround- for example <a href="http://bi-review.blogspot.ru/2012/05/how-to-write-reusable-and-expandable.html">that</a>. 
Basically you change your commas to something else in input parameters and then you replace that something with commas in target expression. It’s good solution for some cases, but 
sometimes that would not work. </p>

<p>Consider long multi-branched <code>if</code> expression that returns trendy icon based on input value</p>

<pre><code>
---
set: ArrowIconForTrendValue
definition: if($1 = 0 OR IsNull($1), null(), 'qmem://&lt;builtin&gt;/' &amp; 
  if($1 &gt;= 1.20,'Arrow_N_G.png',
  if($1 &gt;= 1.051,'Arrow_NE_G.png',
  if($1 &gt;= 1.05 ,'Arrow_NE_G.png',
  if($1 &gt;= 1,'Arrow_E_Y.png',
  if($1 &gt;= .95 ,'Arrow_W_Y.png',
  if($1 &gt;= .801  ,'Arrow_SE_R.png',
  if($1 &gt;= .80 ,'Arrow_S_R.png',
  if($1 &gt;= 0 ,'Arrow_S_R.png','Arrow_S_R.png')))))))))
</code></pre>

<p>Firstly you hardly want to replace all $1’s with $(=Replace(‘$1’, ‘;’, ‘,’)) in that
expression.</p>

<p>Secondly - say you want use <code>$(Sales1998to1997)</code> as input parameter of that <code>ArrowIconForTrendValue</code> expression. You can’t because <code>Sales1998to1997</code> is plain expression defined before as <code>$(Sales1998)/$(Sales1997)</code>. And <code>Sales1998</code> in it defined as <code>Sum(If(Year(OrderDate)=1998, Quantity*UnitPrice))</code> which is in fact contains comma in question. </p>

<p>So we not only should make our function expression (ArrowIconForTrendValue) less readable but also should make all parameters for that function anew - not using already existing expressions. That does not compose well.</p>

<p>Enter the Expression Editor <code>macro</code>. Given <code>ArrowIconForTrendValue</code> and <code>Sales1998to1997</code> expressions above we can define new variable as </p>

<pre><code>
---
set: ArrowIconForSales1998to1997
macro: ArrowIconForTrendValue
  - $(Sales1998to1997)
</code></pre>

<p>Macro tag get function expression name and YAML formatter list of parameters (in that example one parameter). Output format for that expression in CSV file would be:</p>

<pre><code>SET ArrowIconForSalesTrend,"if($(Sales1998to1997) = 0 OR IsNull($(Sales1998to1997)), null(), 'qmem://&lt;builtin&gt;/' &amp; if($(Sales1998to1997) &gt;= 1.20,'Arrow_N_G.png', if($(Sales1998to1997) &gt;= 1.051,'Arrow_NE_G.png', if($(Sales1998to1997) &gt;= 1.05 ,'Arrow_NE_G.png', if($(Sales1998to1997) &gt;= 1,'Arrow_E_Y.png', if($(Sales1998to1997) &gt;= .95 ,'Arrow_W_Y.png', if($(Sales1998to1997) &gt;= .801  ,'Arrow_SE_R.png', if($(Sales1998to1997) &gt;= .80 ,'Arrow_S_R.png', if($(Sales1998to1997) &gt;= 0 ,'Arrow_S_R.png','Arrow_S_R.png')))))))))",,
</code></pre>

<p>So on code-generation phase plugin would emulate dollar sign substitution of expression parameter with actual value, so QlikView would get clean expanded variable without any parameter, ready for further processing. I’ve included these sample expressions in demo project</p>

<p>We do not use this feature frequently but when we do - it is nice to have.</p>

<h3 id="using-of-demo-project">Using of demo project</h3>

<p>You can <a href="/downloads/InqlikExpressionEditorDemoProject.zip">download</a> and look at materials used in this post. Demo project is based on demo application <code>NorthWindExampleMart</code> from QlikView Deployment Framework. QDF file structure per se was not used in this tiny example, but essential function <code>LoadVariableCSV</code> was used.</p>

<p><code>NorthWindExampleMart_Original.qvw</code> is essentially NorthWindExampleMart application fro QVF, adapted for stripped down environment of demo project.</p>

<p><code>NorthWindExampleMart_WithExpression.qvw</code> is the same application with added section for loading variables from csv file and all chart expressions modified to use these loaded variables. Initially this application loads static labels and comments. To get last example with dynamically localized labels and comments you should uncomment last line in file LoadApp_WithExpressions.qvs </p>

<p>To look at InQlik Expression Editor in action you should install <a href="http://www.sublimetext.com/3">Sublime Text 3</a> and <a href="https://github.com/inqlik/inqlik-tools">InQlik Tools</a></p>

<p><a href="/2014/03/expression-editor-part-two/">InQlik Expression Editor, part two</a></p>

<div class="footnotes">
  <ol>
    <li id="fn:1">

      <p>I define Comment arbitrary when it is absent in original application. It’s just a habit to have both Label and Comment for chart expression. Actually in that application Comments mostly not used in charts, but if I simply switch any box diagram into straight table for example - it would be nice to have them from the start. On the other hand simple variables not used as chart expression usually have only name (defined in LET or SET part of expression block) and definition. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">

      <p>In previous version of Expression Editor we used disconnected table for expressions metadata. So expressions labels used to look like $(GetLabel(AvgOrder)).</p>

      <p>Current solution (with clustered group of variables for each expression: <code>Sales</code>, <code>Sales.Label</code>, <code>Sales.Comment</code>, <code>Sales.TextColor</code> for example) was inspired by QlikView Deployment Framework. QlikView Deployment Framework has option to store Comments for variable in linked variable.</p>

      <p>That solution has already proved itself as a big improvement. First of all <code>=Sales.Label</code> looks slightly better then <code>$(GetLabel(Sales))</code>. But arguably more important part is: QlikView itself provide much more support in design time with this approach. In edit box for Label value for example, when you  start typing =Sale - you get possible completions, and immediately know if corresponding variable exists. If not - expression would be red underscored. Inside the $() you can write devil and all. No completions, and QlikView will indifferently color right thing and nonsense alike in dim gray. Such a difference matter a lot on the visualization phase.  <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>There was some cheating - I created and hid listbox for language selection beforehand.    <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


	<div class="comments">
		<a href="/2014/02/expression-editor/#disqus_thread" title="Show comments">Comments</a>
	</div>
 
  

 
<div class="paginator">
  
  <div class="left_column">
    
      <a href="/page6/" title="Older entries">&laquo; older entries</a>
    
		&nbsp;
  </div>
  
  <form action="http://www.google.com/search" id="search" method="get" class="search_column">
  <fieldset>
    <input class="text" name="q" type="text" />
    <input name="sitesearch" type="hidden" value="inqlik.gitgub.io" />
    <input class="button" type="submit" value="Search" />
  </fieldset>
</form>
  
  <div class="right_column">
    
      <a href="
        
          /page4
        " title="Newer entries">newer entries &raquo;</a>
    
		&nbsp;
  </div>
 
  <div class="clear_both">
  </div>
 
</div>
		
    <div id="footer">
      Powered by <a href="http://github.com/mojombo/jekyll" title="Jekyll Site Generator">Jekyll</a> &amp; <a href="http://disqus.com/" title="Disqus Commenting System">Disqus</a>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47706781-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    </div>
 
		<script type="text/javascript">
		    var disqus_shortname = 'inqlik';

		    (function () {
		        var s = document.createElement('script'); s.async = true;
		        s.type = 'text/javascript';
		        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
		        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		    }());
		</script>
		
  </body>
</html>